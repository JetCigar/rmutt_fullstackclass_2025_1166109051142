// 1. บอก Prisma ว่าจะเชื่อมต่อกับ DB อะไร
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Role {
  role_id     Int      @id @default(autoincrement())
  role_name   String   @db.VarChar(100)
  description String?  @db.Text
  admins      Admin[]

  @@map("roles")
}

model Admin {
  admin_id      Int      @id @default(autoincrement())
  role_id       Int
  username      String   @unique @db.VarChar(50)
  password_hash String   @db.VarChar(255)
  email         String   @unique @db.VarChar(100)
  created_at    DateTime? @default(now()) @db.Timestamp(6)
  
  role          Role     @relation(fields: [role_id], references: [role_id])
  status_history OrderStatusHistory[]

  @@map("admins")
}

model Customer {
  customer_id   Int      @id @default(autoincrement())
  first_name    String   @db.VarChar(100)
  last_name     String   @db.VarChar(100)
  email         String   @unique @db.VarChar(255)
  password_hash String   @db.VarChar(255)
  phone         String?  @db.VarChar(20)
  created_at    DateTime? @default(now()) @db.Timestamp(6)
  
  addresses     Address[]
  orders        Order[]
  reviews       Review[]

  @@map("customers")
}

model Address {
  address_id   Int      @id @default(autoincrement())
  customer_id  Int
  address_line String   @db.Text
  province     String?  @db.VarChar(100)
  zip_code     String?  @db.VarChar(10)
  is_default   Boolean? @default(false)
  
  customer     Customer @relation(fields: [customer_id], references: [customer_id], onDelete: Cascade)
  shippings    Shipping[]

  @@map("addresses")
}

model Category {
  category_id        Int      @id @default(autoincrement())
  name               String   @db.VarChar(255)
  description        String?  @db.Text
  parent_category_id Int?
  created_at         DateTime? @default(now()) @db.Timestamp(6)
  updated_at         DateTime? @default(now()) @db.Timestamp(6)
  
  parent             Category?  @relation("CategoryToCategory", fields: [parent_category_id], references: [category_id])
  child_categories   Category[] @relation("CategoryToCategory")
  products           Product[]

  @@map("categories")
}

model Product {
  product_id     Int      @id @default(autoincrement())
  category_id    Int
  sku            String   @unique @db.VarChar(100)
  name           String   @db.VarChar(255)
  description    String?  @db.Text
  price          Decimal  @db.Decimal(10, 2)
  weight         Decimal? @db.Decimal(8, 2)
  stock_quantity Int      @default(0)
  attributes     Json?
  is_active      Boolean? @default(true)
  created_at     DateTime? @default(now()) @db.Timestamp(6)
  updated_at     DateTime? @default(now()) @db.Timestamp(6)
  
  category       Category @relation(fields: [category_id], references: [category_id])
  images         ProductImage[]
  order_items    OrderItem[]
  reviews        Review[]

  @@map("products")
}

model ProductImage {
  image_id   Int      @id @default(autoincrement())
  product_id Int
  image_url  String   @db.Text
  is_primary Boolean? @default(false)
  created_at DateTime? @default(now()) @db.Timestamp(6)
  
  product    Product  @relation(fields: [product_id], references: [product_id], onDelete: Cascade)

  @@map("product_images")
}

model Discount {
  discount_id     Int      @id @default(autoincrement())
  code            String   @unique @db.VarChar(50)
  discount_amount Decimal  @db.Decimal(10, 2)
  is_active       Boolean? @default(true)
  orders          Order[]

  @@map("discounts")
}

model Order {
  order_id      Int      @id @default(autoincrement())
  customer_id   Int
  discount_id   Int?
  total_amount  Decimal  @db.Decimal(10, 2)
  status        String?  @default("pending") @db.VarChar(50)
  created_at    DateTime? @default(now()) @db.Timestamp(6)
  
  customer      Customer @relation(fields: [customer_id], references: [customer_id])
  discount      Discount? @relation(fields: [discount_id], references: [discount_id])
  order_items   OrderItem[]
  status_history OrderStatusHistory[]
  payment       Payment?
  shipping      Shipping?

  @@map("orders")
}

model OrderItem {
  order_item_id     Int     @id @default(autoincrement())
  order_id          Int
  product_id        Int
  quantity          Int
  price_at_purchase Decimal @db.Decimal(10, 2)
  
  order             Order   @relation(fields: [order_id], references: [order_id], onDelete: Cascade)
  product           Product @relation(fields: [product_id], references: [product_id])

  @@map("order_items")
}

model OrderStatusHistory {
  history_id Int      @id @default(autoincrement())
  order_id   Int
  status     String   @db.VarChar(50)
  admin_id   Int?
  created_at DateTime? @default(now()) @db.Timestamp(6)
  
  order      Order    @relation(fields: [order_id], references: [order_id], onDelete: Cascade)
  admin      Admin?   @relation(fields: [admin_id], references: [admin_id])

  @@map("order_status_history")
}

model Payment {
  payment_id     Int       @id @default(autoincrement())
  order_id       Int       @unique
  amount         Decimal   @db.Decimal(10, 2)
  payment_method String?   @db.VarChar(50)
  status         String?   @default("pending") @db.VarChar(50)
  paid_at        DateTime? @db.Timestamp(6)
  
  order          Order     @relation(fields: [order_id], references: [order_id], onDelete: Cascade)

  @@map("payments")
}

model Shipping {
  shipping_id     Int       @id @default(autoincrement())
  order_id        Int       @unique
  address_id      Int
  tracking_number String?   @db.VarChar(100)
  status          String?   @default("preparing") @db.VarChar(50)
  shipped_at      DateTime? @db.Timestamp(6)
  
  order           Order     @relation(fields: [order_id], references: [order_id], onDelete: Cascade)
  address         Address   @relation(fields: [address_id], references: [address_id])

  @@map("shipping")
}

model Review {
  review_id   Int      @id @default(autoincrement())
  product_id  Int
  customer_id Int
  rating      Int
  comment     String?  @db.Text
  created_at  DateTime? @default(now()) @db.Timestamp(6)
  
  product     Product  @relation(fields: [product_id], references: [product_id], onDelete: Cascade)
  customer    Customer @relation(fields: [customer_id], references: [customer_id], onDelete: Cascade)

  @@map("reviews")
}